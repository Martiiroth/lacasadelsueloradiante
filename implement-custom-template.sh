#!/bin/bash

# ============================================================================
# IMPLEMENTAR PLANTILLA HTML PERSONALIZADA PARA RESET PASSWORD
# ============================================================================

echo "üé® IMPLEMENTANDO PLANTILLA HTML PERSONALIZADA PARA RESET"
echo ""

echo "üìã PASOS PARA IMPLEMENTAR:"
echo ""

echo "1Ô∏è‚É£  SUBIR LA PLANTILLA A TU WEB:"
echo ""
echo "# Crear directorio en tu aplicaci√≥n Next.js:"
echo "mkdir -p public/templates"
echo ""
echo "# La plantilla ya est√° creada en: public/templates/recovery-email.html"
echo "# Aseg√∫rate de que est√© accesible en:"
echo "# https://lacasadelsueloradiante.es/templates/recovery-email.html"
echo ""

echo "2Ô∏è‚É£  VERIFICAR QUE LA PLANTILLA SEA ACCESIBLE:"
echo ""
echo "# Desde tu m√°quina local, verificar que la plantilla se sirve:"
echo "curl -I https://lacasadelsueloradiante.es/templates/recovery-email.html"
echo ""
echo "# Deber√≠a devolver: HTTP/2 200"
echo ""

echo "3Ô∏è‚É£  CONFIGURAR EL .ENV EN EL SERVIDOR VPS:"
echo ""
echo "ssh root@tu-servidor-ip"
echo "cd ~/supabase-automated-self-host/docker"
echo ""
echo "# Hacer backup"
echo "cp .env .env.backup-template-\$(date +%Y%m%d-%H%M%S)"
echo ""
echo "# Editar .env y a√±adir/modificar estas l√≠neas:"
echo "nano .env"
echo ""

echo "üìù CONFIGURACI√ìN PARA EL .ENV DEL SERVIDOR:"
echo ""
echo "# ‚úÖ CONFIGURACI√ìN B√ÅSICA (verificar que est√© correcto)"
echo "SITE_URL=https://lacasadelsueloradiante.es"
echo "MAILER_URLPATHS_RECOVERY=/auth/reset-password"
echo "ADDITIONAL_REDIRECT_URLS=https://lacasadelsueloradiante.es/**,https://lacasadelsueloradiante.es/auth/**"
echo ""
echo "# ‚úÖ PLANTILLA HTML PERSONALIZADA (a√±adir esta l√≠nea)"
echo "MAILER_TEMPLATES_RECOVERY=https://lacasadelsueloradiante.es/templates/recovery-email.html"
echo ""
echo "# ‚úÖ SUJETO PERSONALIZADO (opcional)"
echo "MAILER_SUBJECTS_RECOVERY=Recupera tu contrase√±a - La Casa del Suelo Radiante"
echo ""
echo "# ‚ùå ELIMINAR estas l√≠neas si existen (NO son v√°lidas)"
echo "# GOTRUE_EXTERNAL_REDIRECT_ENABLED=true"
echo "# GOTRUE_MAILER_AUTOCONFIRM_REDIRECTS=true"
echo ""

echo "4Ô∏è‚É£  REINICIAR EL SERVICIO AUTH:"
echo ""
echo "# Solo reiniciar el servicio auth (m√°s r√°pido)"
echo "docker-compose restart auth"
echo ""
echo "# Verificar que est√© funcionando"
echo "docker logs supabase-auth --tail 10"
echo ""

echo "5Ô∏è‚É£  PROBAR EL RESET CON PLANTILLA:"
echo ""
echo "# Probar desde el servidor o tu m√°quina local:"
echo "curl -X POST \"https://supabase.lacasadelsueloradianteapp.com/auth/v1/recover\" \\"
echo "  -H \"Content-Type: application/json\" \\"
echo "  -H \"apikey: \${ANON_KEY}\" \\"
echo "  -d '{\"email\": \"djmartiiservicios@gmail.com\"}'"
echo ""

echo "6Ô∏è‚É£  VERIFICAR EL EMAIL RECIBIDO:"
echo ""
echo "‚úÖ El email deber√≠a usar tu plantilla HTML personalizada"
echo "‚úÖ El bot√≥n deber√≠a apuntar a: https://lacasadelsueloradiante.es/auth/reset-password?token=xxx"
echo "‚úÖ Deber√≠a tener el dise√±o de tu empresa"
echo ""

echo "üîç TROUBLESHOOTING:"
echo ""
echo "Si la plantilla no se usa:"
echo ""
echo "1. Verificar que la URL de la plantilla sea accesible:"
echo "   curl https://lacasadelsueloradiante.es/templates/recovery-email.html"
echo ""
echo "2. Verificar logs de auth:"
echo "   docker logs supabase-auth | grep -i template"
echo ""
echo "3. Verificar configuraci√≥n actual:"
echo "   grep MAILER_TEMPLATES_RECOVERY .env"
echo ""
echo "4. Si hay errores, usar plantilla por defecto temporalmente:"
echo "   MAILER_TEMPLATES_RECOVERY="
echo ""

echo "üéØ C√ìMO FUNCIONA:"
echo ""
echo "1. GoTrue lee MAILER_TEMPLATES_RECOVERY del .env"
echo "2. Descarga la plantilla HTML desde tu web"
echo "3. Reemplaza {{ .ConfirmationURL }}, {{ .Email }}, {{ .SiteURL }}"
echo "4. Env√≠a el email con tu plantilla personalizada"
echo "5. El link apunta a SITE_URL + MAILER_URLPATHS_RECOVERY + token"
echo ""

echo "üìß RESULTADO FINAL:"
echo "   Email con dise√±o personalizado"
echo "   Link: https://lacasadelsueloradiante.es/auth/reset-password?token=xxx&type=recovery"
echo "   Sujeto: Recupera tu contrase√±a - La Casa del Suelo Radiante"