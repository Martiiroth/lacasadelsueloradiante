#!/bin/bash

# ============================================================================
# VERIFICACI√ìN COMPLETA DEL redirectTo EN EL FLUJO DE RESET PASSWORD
# ============================================================================

echo "üîó VERIFICANDO CONFIGURACI√ìN DE redirectTo"
echo ""

echo "==========================================================================="
echo "üìß PASO 1: FUNCI√ìN DE ENV√çO DE EMAIL (resetPasswordForEmail)"
echo "==========================================================================="
echo ""
echo "üìÅ Archivo: src/app/api/send-reset-email/route.ts"
echo ""
echo "‚úÖ Configuraci√≥n actual:"
echo "await supabase.auth.resetPasswordForEmail(email, {"
echo "  redirectTo: 'https://lacasadelsueloradiante.es/auth/reset-password'"
echo "})"
echo ""
echo "üéØ Esto hace que Supabase genere links como:"
echo "https://lacasadelsueloradiante.es/auth/reset-password?access_token=xxx&refresh_token=yyy"
echo ""

echo "==========================================================================="
echo "‚öôÔ∏è PASO 2: CONFIGURACI√ìN EN EL SERVIDOR SUPABASE"
echo "==========================================================================="
echo ""
echo "üìÅ Archivo en servidor: /root/supabase-automated-self-host/docker/.env"
echo ""
echo "‚úÖ Variables clave que deben coincidir:"
echo ""
echo "SITE_URL=https://lacasadelsueloradiante.es"
echo "MAILER_URLPATHS_RECOVERY=/auth/reset-password"
echo "ADDITIONAL_REDIRECT_URLS=https://lacasadelsueloradiante.es/**,https://lacasadelsueloradiante.es/auth/**"
echo ""
echo "üîÑ C√≥mo funciona:"
echo "1. resetPasswordForEmail() respeta el redirectTo del cliente"
echo "2. SITE_URL define el dominio base permitido"
echo "3. ADDITIONAL_REDIRECT_URLS permite las rutas espec√≠ficas"
echo "4. MAILER_URLPATHS_RECOVERY define la ruta en el template de email"
echo ""

echo "==========================================================================="
echo "üñ•Ô∏è PASO 3: HANDLER EN EL FRONTEND"
echo "==========================================================================="
echo ""
echo "üìÅ Archivo: src/app/auth/reset-password/page.tsx"
echo ""
echo "‚úÖ Maneja ambos formatos de tokens:"
echo ""
echo "1. FORMATO MODERNO (access_token + refresh_token):"
echo "   - URL: https://lacasadelsueloradiante.es/auth/reset-password?access_token=xxx&refresh_token=yyy"
echo "   - Flujo: page.tsx ‚Üí /api/reset-password ‚Üí supabase.auth.setSession() ‚Üí updateUser()"
echo ""
echo "2. FORMATO PKCE (token √∫nico):"
echo "   - URL: https://lacasadelsueloradiante.es/auth/reset-password?token=xxx&type=recovery"
echo "   - Flujo: page.tsx ‚Üí supabase.auth.verifyOtp() ‚Üí updateUser()"
echo ""

echo "==========================================================================="
echo "üß™ PASO 4: PROBAR EL FLUJO COMPLETO"
echo "==========================================================================="
echo ""
echo "1Ô∏è‚É£ Enviar email de reset:"
echo ""
echo "curl -X POST \"http://localhost:3000/api/send-reset-email\" \\"
echo "  -H \"Content-Type: application/json\" \\"
echo "  -d '{\"email\": \"djmartiiservicios@gmail.com\"}'"
echo ""

echo "2Ô∏è‚É£ Verificar que el email llegue con el link correcto:"
echo ""
echo "‚úÖ El email debe contener un link como:"
echo "https://lacasadelsueloradiante.es/auth/reset-password?access_token=xxx&refresh_token=yyy"
echo "o"
echo "https://lacasadelsueloradiante.es/auth/reset-password?token=xxx&type=recovery"
echo ""

echo "3Ô∏è‚É£ Al hacer clic en el link:"
echo ""
echo "‚úÖ Debe abrir: https://lacasadelsueloradiante.es/auth/reset-password"
echo "‚úÖ Debe mostrar el formulario de nueva contrase√±a"
echo "‚úÖ Debe permitir cambiar la contrase√±a exitosamente"
echo ""

echo "==========================================================================="
echo "üîß TROUBLESHOOTING"
echo "==========================================================================="
echo ""
echo "‚ùå Si el link en el email apunta al dominio de Supabase:"
echo ""
echo "1. Verificar en el servidor VPS:"
echo "   ssh root@servidor"
echo "   cd ~/supabase-automated-self-host/docker"
echo "   grep -E 'SITE_URL|ADDITIONAL_REDIRECT' .env"
echo ""
echo "2. Debe mostrar:"
echo "   SITE_URL=https://lacasadelsueloradiante.es"
echo "   ADDITIONAL_REDIRECT_URLS=https://lacasadelsueloradiante.es/**"
echo ""
echo "3. Si no est√° correcto, editar:"
echo "   nano .env"
echo "   docker-compose restart auth"
echo ""

echo "‚ùå Si el frontend no puede manejar los tokens:"
echo ""
echo "1. Verificar en los logs del navegador"
echo "2. Verificar que page.tsx maneja ambos formatos de token"
echo "3. Verificar que /api/reset-password funciona"
echo ""

echo "==========================================================================="
echo "üìã RESUMEN DE CONFIGURACI√ìN CR√çTICA"
echo "==========================================================================="
echo ""
echo "üéØ Para que redirectTo funcione correctamente:"
echo ""
echo "1. EN EL CLIENTE (resetPasswordForEmail):"
echo "   redirectTo: 'https://lacasadelsueloradiante.es/auth/reset-password'"
echo ""
echo "2. EN EL SERVIDOR (.env de Supabase):"
echo "   SITE_URL=https://lacasadelsueloradiante.es"
echo "   ADDITIONAL_REDIRECT_URLS=https://lacasadelsueloradiante.es/**"
echo ""
echo "3. EN EL FRONTEND (page.tsx):"
echo "   Manejar access_token + refresh_token O token + type"
echo ""
echo "‚úÖ Con esta configuraci√≥n, el flujo ser√°:"
echo "resetPasswordForEmail() ‚Üí Email con link correcto ‚Üí Tu p√°gina ‚Üí Cambio exitoso"
echo ""

echo "üöÄ ¬øTodo est√° configurado correctamente? Ejecuta la prueba:"
echo "curl -X POST \"http://localhost:3000/api/send-reset-email\" -H \"Content-Type: application/json\" -d '{\"email\": \"djmartiiservicios@gmail.com\"}'"