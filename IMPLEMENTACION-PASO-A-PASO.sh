#!/bin/bash

# ============================================================================
# SCRIPT DE IMPLEMENTACI√ìN PASO A PASO
# Ejecutar cada secci√≥n una por una
# ============================================================================

echo "üöÄ IMPLEMENTACI√ìN COMPLETA - PASO A PASO"
echo ""

echo "==========================================================================="
echo "üìã PASO 1: VERIFICAR QUE LA PLANTILLA SEA ACCESIBLE"
echo "==========================================================================="
echo ""
echo "Antes de configurar el servidor, verifica que tu plantilla est√© online:"
echo ""
echo "curl -I https://lacasadelsueloradiante.es/templates/recovery-email.html"
echo ""
echo "‚úÖ Debe devolver: HTTP/2 200"
echo "‚ùå Si devuelve 404, primero haz deploy de tu aplicaci√≥n Next.js"
echo ""
echo "Presiona ENTER cuando la plantilla est√© accesible..."
read -r

echo "==========================================================================="
echo "üîß PASO 2: CONECTAR AL SERVIDOR Y HACER BACKUP"
echo "==========================================================================="
echo ""
echo "Ejecuta estos comandos:"
echo ""
echo "ssh root@tu-servidor-ip"
echo ""
echo "Una vez conectado al servidor, ejecuta:"
echo ""
echo "cd ~/supabase-automated-self-host/docker"
echo "pwd  # Verifica que est√©s en el directorio correcto"
echo "ls -la .env  # Verifica que el archivo .env existe"
echo ""
echo "# Hacer backup del .env actual"
echo "cp .env .env.backup-\$(date +%Y%m%d-%H%M%S)"
echo "ls -la .env*  # Verifica que el backup se cre√≥"
echo ""
echo "Presiona ENTER cuando hayas hecho el backup..."
read -r

echo "==========================================================================="
echo "üìù PASO 3: EDITAR EL ARCHIVO .ENV"
echo "==========================================================================="
echo ""
echo "En el servidor, ejecuta:"
echo ""
echo "nano .env"
echo ""
echo "üîç BUSCAR Y ELIMINAR estas l√≠neas (si existen):"
echo ""
echo "‚ùå GOTRUE_EXTERNAL_REDIRECT_ENABLED=true"
echo "‚ùå GOTRUE_MAILER_AUTOCONFIRM_REDIRECTS=true"
echo ""
echo "‚úÖ BUSCAR Y VERIFICAR/A√ëADIR estas l√≠neas:"
echo ""
echo "SITE_URL=https://lacasadelsueloradiante.es"
echo "MAILER_URLPATHS_RECOVERY=/auth/reset-password"
echo "ADDITIONAL_REDIRECT_URLS=https://lacasadelsueloradiante.es/**,https://lacasadelsueloradiante.es/auth/**,https://lacasadelsueloradiante.es/auth/reset-password"
echo ""
echo "‚úÖ A√ëADIR esta l√≠nea nueva (plantilla personalizada):"
echo ""
echo "MAILER_TEMPLATES_RECOVERY=https://lacasadelsueloradiante.es/templates/recovery-email.html"
echo ""
echo "‚úÖ OPCIONAL - A√±adir sujeto personalizado:"
echo ""
echo "MAILER_SUBJECTS_RECOVERY=Recupera tu contrase√±a - La Casa del Suelo Radiante"
echo ""
echo "üíæ Guardar con: Ctrl+O, Enter, Ctrl+X"
echo ""
echo "Presiona ENTER cuando hayas editado el .env..."
read -r

echo "==========================================================================="
echo "üîç PASO 4: VERIFICAR LA CONFIGURACI√ìN"
echo "==========================================================================="
echo ""
echo "En el servidor, verifica que los cambios se guardaron correctamente:"
echo ""
echo "grep -E 'SITE_URL|MAILER.*RECOVERY|ADDITIONAL_REDIRECT|GOTRUE_EXTERNAL' .env"
echo ""
echo "‚úÖ Deber√≠as ver algo como:"
echo "SITE_URL=https://lacasadelsueloradiante.es"
echo "MAILER_URLPATHS_RECOVERY=/auth/reset-password"
echo "MAILER_TEMPLATES_RECOVERY=https://lacasadelsueloradiante.es/templates/recovery-email.html"
echo "MAILER_SUBJECTS_RECOVERY=Recupera tu contrase√±a - La Casa del Suelo Radiante"
echo "ADDITIONAL_REDIRECT_URLS=https://lacasadelsueloradiante.es/**,..."
echo ""
echo "‚ùå NO deber√≠as ver:"
echo "GOTRUE_EXTERNAL_REDIRECT_ENABLED"
echo "GOTRUE_MAILER_AUTOCONFIRM_REDIRECTS"
echo ""
echo "Presiona ENTER cuando hayas verificado la configuraci√≥n..."
read -r

echo "==========================================================================="
echo "üîÑ PASO 5: REINICIAR EL SERVICIO AUTH"
echo "==========================================================================="
echo ""
echo "En el servidor:"
echo ""
echo "# Ver servicios actuales"
echo "docker-compose ps"
echo ""
echo "# Reiniciar solo el servicio auth (m√°s r√°pido)"
echo "docker-compose restart auth"
echo ""
echo "# Verificar que est√© funcionando"
echo "docker-compose ps | grep auth"
echo "docker logs supabase-auth --tail 10"
echo ""
echo "‚úÖ El servicio 'supabase-auth' deber√≠a estar 'Up' y sin errores en los logs"
echo ""
echo "Presiona ENTER cuando el servicio est√© funcionando..."
read -r

echo "==========================================================================="
echo "üß™ PASO 6: PROBAR EL RESET PASSWORD"
echo "==========================================================================="
echo ""
echo "Desde el servidor o tu m√°quina local, ejecuta:"
echo ""
echo "curl -X POST \"https://supabase.lacasadelsueloradianteapp.com/auth/v1/recover\" \\"
echo "  -H \"Content-Type: application/json\" \\"
echo "  -H \"apikey: eyJ0eXAiOiAiSldUIiwiYWxnIjogIkhTMjU2In0.ewogICJyb2xlIjogImFub24iLAogICJpc3MiOiAic3VwYWJhc2UiLAogICJpYXQiOiAxNzU4NzAwNTMzLAogICJleHAiOiAxOTE2MzgwNTMzCn0.uhOFMEExih6oXgd9tDGK87L-xQMK6J-6w5oPDs2tnbc\" \\"
echo "  -d '{\"email\": \"djmartiiservicios@gmail.com\"}'"
echo ""
echo "‚úÖ Deber√≠a devolver algo como: {}"
echo "‚úÖ El email deber√≠a llegar en 1-2 minutos"
echo ""
echo "Presiona ENTER cuando hayas enviado la petici√≥n..."
read -r

echo "==========================================================================="
echo "üìß PASO 7: VERIFICAR EL EMAIL RECIBIDO"
echo "==========================================================================="
echo ""
echo "Revisa el email en djmartiiservicios@gmail.com"
echo ""
echo "‚úÖ El email deber√≠a tener:"
echo "   - Sujeto: 'Recupera tu contrase√±a - La Casa del Suelo Radiante'"
echo "   - Dise√±o personalizado con tu branding"
echo "   - Bot√≥n que apunte a: https://lacasadelsueloradiante.es/auth/reset-password?token=xxx"
echo ""
echo "‚ùå Si el email no llega o tiene problemas:"
echo "   1. Revisar logs: docker logs supabase-auth | grep -i recovery"
echo "   2. Verificar plantilla: curl https://lacasadelsueloradiante.es/templates/recovery-email.html"
echo "   3. Verificar SMTP: docker logs supabase-auth | grep -i smtp"
echo ""

echo "==========================================================================="
echo "üéØ RESUMEN DE LO QUE HICIMOS"
echo "==========================================================================="
echo ""
echo "üìÅ Archivos modificados en el servidor:"
echo "   - /root/supabase-automated-self-host/docker/.env"
echo ""
echo "üîß Configuraci√≥n a√±adida:"
echo "   - MAILER_TEMPLATES_RECOVERY=https://lacasadelsueloradiante.es/templates/recovery-email.html"
echo "   - MAILER_SUBJECTS_RECOVERY=Recupera tu contrase√±a - La Casa del Suelo Radiante"
echo "   - Eliminadas variables inexistentes"
echo ""
echo "üé® Plantilla HTML:"
echo "   - Servida desde: https://lacasadelsueloradiante.es/templates/recovery-email.html"
echo "   - Con dise√±o personalizado de tu empresa"
echo ""
echo "üîó Resultado:"
echo "   - Emails con plantilla personalizada"
echo "   - Links que apuntan a tu web: https://lacasadelsueloradiante.es/auth/reset-password"
echo ""
echo "¬°IMPLEMENTACI√ìN COMPLETADA! üéâ"