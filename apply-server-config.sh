#!/bin/bash

# ============================================================================
# SCRIPT COMPLETO PARA APLICAR LA CONFIGURACI√ìN CORREGIDA
# ============================================================================

echo "üîÑ APLICANDO CONFIGURACI√ìN CORREGIDA EN EL SERVIDOR VPS"
echo ""

echo "üìã CAMBIOS PRINCIPALES:"
echo "‚úÖ Eliminar variables inexistentes: GOTRUE_EXTERNAL_REDIRECT_ENABLED, GOTRUE_MAILER_AUTOCONFIRM_REDIRECTS"
echo "‚úÖ Configurar ADDITIONAL_REDIRECT_URLS correctamente"
echo "‚úÖ Asegurar MAILER_URLPATHS_RECOVERY=/auth/reset-password"
echo ""

echo "üöÄ COMANDOS PARA EL SERVIDOR:"
echo ""
echo "1. Conectar al servidor VPS:"
echo "   ssh root@tu-servidor-ip"
echo ""
echo "2. Ir al directorio correcto:"
echo "   cd ~/supabase-automated-self-host/docker"
echo ""
echo "3. Hacer backup del .env actual:"
echo "   cp .env .env.backup-\$(date +%Y%m%d-%H%M%S)"
echo ""
echo "4. Aplicar la nueva configuraci√≥n:"
echo "   # Opci√≥n 1: Editar manualmente"
echo "   nano .env"
echo ""
echo "   # Opci√≥n 2: Descargar el archivo corregido"
echo "   wget -O .env https://raw.githubusercontent.com/tuusuario/tu-repo/main/server-env-corrected.env"
echo ""
echo "5. Verificar los cambios importantes:"
echo "   grep -E 'SITE_URL|ADDITIONAL_REDIRECT_URLS|MAILER_URLPATHS_RECOVERY' .env"
echo ""
echo "6. Reiniciar servicios de Supabase:"
echo "   docker-compose down"
echo "   docker-compose up -d"
echo ""
echo "7. Verificar que todos los servicios est√©n funcionando:"
echo "   docker-compose ps"
echo ""
echo "8. Verificar logs del servicio auth:"
echo "   docker logs supabase-auth --tail 20"
echo ""
echo "9. Probar el reset de contrase√±a:"
echo "   curl -X POST \"https://supabase.lacasadelsueloradianteapp.com/auth/v1/recover\" \\"
echo "     -H \"Content-Type: application/json\" \\"
echo "     -H \"apikey: \$ANON_KEY\" \\"
echo "     -d '{\"email\": \"djmartiiservicios@gmail.com\"}'"
echo ""

echo "üìß LA CONFIGURACI√ìN CORRECTA DEBE INCLUIR:"
echo ""
echo "SITE_URL=https://lacasadelsueloradiante.es"
echo "ADDITIONAL_REDIRECT_URLS=https://lacasadelsueloradiante.es/**,https://lacasadelsueloradiante.es/auth/**,https://lacasadelsueloradiante.es/auth/reset-password"
echo "MAILER_URLPATHS_RECOVERY=/auth/reset-password"
echo ""
echo "Y NO DEBE INCLUIR:"
echo "‚ùå GOTRUE_EXTERNAL_REDIRECT_ENABLED"
echo "‚ùå GOTRUE_MAILER_AUTOCONFIRM_REDIRECTS"
echo ""

echo "üîç VERIFICAR FUNCIONAMIENTO:"
echo ""
echo "1. Los emails de reset deber√≠an llegar con URL:"
echo "   https://lacasadelsueloradiante.es/auth/reset-password?token=xxx"
echo ""
echo "2. El token deber√≠a ser v√°lido y funcionar en tu aplicaci√≥n"
echo ""
echo "3. Si a√∫n no funciona, revisar logs:"
echo "   docker logs supabase-auth | grep -i 'recovery\\|reset\\|email'"