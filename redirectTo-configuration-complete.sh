#!/bin/bash

# ============================================================================
# VERIFICACI√ìN COMPLETA: redirectTo CONFIGURADO CORRECTAMENTE
# ============================================================================

echo "‚úÖ CONFIGURACI√ìN DE redirectTo VERIFICADA Y CORREGIDA"
echo ""

echo "========================================================================="
echo "üìß CONFIGURACI√ìN EN EL CLIENTE (API)"
echo "========================================================================="
echo ""
echo "üìÅ Archivo: src/app/api/send-reset-email/route.ts"
echo ""
echo "‚úÖ CORREGIDO - Ahora usa dominio fijo:"
echo ""
echo "await supabase.auth.resetPasswordForEmail(email, {"
echo "  redirectTo: 'https://lacasadelsueloradiante.es/auth/reset-password'"
echo "})"
echo ""
echo "üîÑ Antes usaba: \${process.env.NEXT_PUBLIC_SITE_URL}/auth/reset-password"
echo "‚úÖ Ahora usa: https://lacasadelsueloradiante.es/auth/reset-password"
echo ""

echo "========================================================================="
echo "‚öôÔ∏è CONFIGURACI√ìN EN EL SERVIDOR SUPABASE"
echo "========================================================================="
echo ""
echo "üìÅ Archivo: server-env-with-template.env (para copiar al servidor)"
echo ""
echo "‚úÖ Variables cr√≠ticas:"
echo ""
echo "SITE_URL=https://lacasadelsueloradiante.es"
echo "MAILER_URLPATHS_RECOVERY=/auth/reset-password"
echo "ADDITIONAL_REDIRECT_URLS=https://lacasadelsueloradiante.es/**,https://lacasadelsueloradiante.es/auth/**"
echo ""
echo "üéØ Esto asegura que:"
echo "1. Supabase acepta redirectTo de tu dominio"
echo "2. Los emails generados apunten a tu web"
echo "3. Los tokens sean v√°lidos para tu aplicaci√≥n"
echo ""

echo "========================================================================="
echo "üñ•Ô∏è HANDLER EN EL FRONTEND"
echo "========================================================================="
echo ""
echo "üìÅ Archivo: src/app/auth/reset-password/page.tsx"
echo ""
echo "‚úÖ Maneja dos tipos de tokens que puede enviar Supabase:"
echo ""
echo "1. TOKENS MODERNOS:"
echo "   ?access_token=xxx&refresh_token=yyy"
echo ""
echo "2. TOKENS PKCE:"
echo "   ?token=xxx&type=recovery"
echo ""
echo "‚úÖ Flujos de actualizaci√≥n de contrase√±a:"
echo ""
echo "‚Ä¢ Tokens modernos: page.tsx ‚Üí /api/reset-password ‚Üí supabase.auth.updateUser()"
echo "‚Ä¢ Tokens PKCE: page.tsx ‚Üí supabase.auth.updateUser() directamente"
echo ""

echo "========================================================================="
echo "üöÄ PR√ìXIMOS PASOS PARA IMPLEMENTAR"
echo "========================================================================="
echo ""
echo "1Ô∏è‚É£ HACER DEPLOY DE LA APLICACI√ìN:"
echo ""
echo "# Hacer commit de los cambios"
echo "git add ."
echo "git commit -m 'Fix redirectTo configuration for password reset'"
echo "git push"
echo ""
echo "# Hacer deploy (ejemplo con tu m√©todo actual)"
echo "# docker build, docker push, etc."
echo ""

echo "2Ô∏è‚É£ CONFIGURAR EL SERVIDOR SUPABASE:"
echo ""
echo "ssh root@tu-servidor"
echo "cd ~/supabase-automated-self-host/docker"
echo ""
echo "# Verificar configuraci√≥n actual"
echo "grep -E 'SITE_URL|MAILER.*RECOVERY|ADDITIONAL_REDIRECT' .env"
echo ""
echo "# Si no est√° correcto, editar:"
echo "nano .env"
echo ""
echo "# A√±adir/verificar estas l√≠neas:"
echo "SITE_URL=https://lacasadelsueloradiante.es"
echo "MAILER_URLPATHS_RECOVERY=/auth/reset-password"
echo "ADDITIONAL_REDIRECT_URLS=https://lacasadelsueloradiante.es/**,https://lacasadelsueloradiante.es/auth/**"
echo ""
echo "# Reiniciar auth"
echo "docker-compose restart auth"
echo ""

echo "3Ô∏è‚É£ PROBAR EL FLUJO COMPLETO:"
echo ""
echo "# Una vez que todo est√© deployado:"
echo "curl -X POST \"https://lacasadelsueloradiante.es/api/send-reset-email\" \\"
echo "  -H \"Content-Type: application/json\" \\"
echo "  -d '{\"email\": \"djmartiiservicios@gmail.com\"}'"
echo ""
echo "‚úÖ El email debe llegar con un link a tu dominio"
echo "‚úÖ El link debe abrir tu formulario de reset"
echo "‚úÖ Debe permitir cambiar la contrase√±a exitosamente"
echo ""

echo "========================================================================="
echo "üéØ RESULTADO ESPERADO"
echo "========================================================================="
echo ""
echo "üìß Email de reset con:"
echo "   ‚Ä¢ Sujeto: Recupera tu contrase√±a - La Casa del Suelo Radiante"
echo "   ‚Ä¢ Link: https://lacasadelsueloradiante.es/auth/reset-password?access_token=xxx"
echo "   ‚Ä¢ Dise√±o personalizado (si usas template HTML)"
echo ""
echo "üîó Al hacer clic:"
echo "   ‚Ä¢ Abre tu aplicaci√≥n directamente"
echo "   ‚Ä¢ Muestra formulario de nueva contrase√±a"
echo "   ‚Ä¢ Permite cambio exitoso sin errores"
echo ""

echo "‚úÖ CONFIGURACI√ìN COMPLETADA"
echo ""
echo "Los archivos han sido actualizados para asegurar que:"
echo ""
echo "1. resetPasswordForEmail() use el redirectTo correcto"
echo "2. El servidor Supabase tenga las URLs permitidas"
echo "3. El frontend maneje ambos tipos de tokens"
echo ""
echo "üöÄ Ahora solo falta implementar en el servidor y probar!"